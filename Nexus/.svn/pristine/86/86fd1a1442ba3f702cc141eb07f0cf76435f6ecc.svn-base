package org.swssm.nexus.TimeTable;

import java.io.IOException;
import java.io.InputStream;
import java.text.ParseException;
import java.util.HashMap;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.DefaultHttpClient;
import org.xmlpull.v1.XmlPullParser;
import org.xmlpull.v1.XmlPullParserException;
import org.xmlpull.v1.XmlPullParserFactory;

import android.app.ProgressDialog;
import android.content.Context;
import android.util.Log;

public class HdtvTimeTable extends Thread {
	
	private HashMap<String, Channel>	mChannelList;
	
	
	public HdtvTimeTable() {
		mChannelList=new HashMap<String, Channel>();
	}
	
	@Override
	public void run() {
		getHdtvTimeTableImpl();
	}
	
	HashMap<String, Channel> getHdtvTimeTable(Context context) {
		
		
		try {
			ProgressDialog dlg=new ProgressDialog(context);
			dlg.setMessage("HDTV 편성표를 가지고 오고 있습니다.");
			dlg.show();
			
			this.start();
			this.join();
			
			dlg.dismiss();
		} catch (InterruptedException e) {
			Log.e("lueseypid", e.getMessage());
		}
		
		Log.i("lueseypid", "Hdtv timetable parsing complete");
		
		return mChannelList;
	}
	
	private void getHdtvTimeTableImpl() {
		try {
			HttpClient http=new DefaultHttpClient();
			InputStream is;
			
			HttpGet get=new HttpGet("http://test4.me/mc/xmltv.xml");
			HttpResponse response = http.execute(get);
			int statusCode = response.getStatusLine().getStatusCode();
			
			if(statusCode == 200) {
				Log.d("LueseyPid", "연결성공");
				HttpEntity entitiy=response.getEntity();
				is=entitiy.getContent();
							
				XmlPullParserFactory factory=XmlPullParserFactory.newInstance();
				XmlPullParser xpp=factory.newPullParser();
				xpp.setInput(is, "UTF-8");
				
				parsingChannelInfo(xpp);
				
			} else {
				Log.d("lueseypid", "연결실패");
			}
			
		} catch (ClientProtocolException e) {
			Log.e("lueseypid", "Error : " + e.getMessage());
		} catch (IOException e) {
			Log.e("lueseypid", "Error : " + e.getMessage());
		} catch (XmlPullParserException e) {
			Log.e("lueseypid", "Error : " + e.getMessage());
		} catch (ParseException e) {
			Log.e("lueseypid", "Error : " + e.getMessage());
		}
		
		/*
		Iterator<String> iterator = mChannelList.keySet().iterator();
		while(iterator.hasNext()) {
			String key=iterator.next();
			 Log.d("lueseypid", "------------------");
			 Log.d("lueseypid", mChannelList.get(key).getId());
			 Log.d("lueseypid", mChannelList.get(key).getChannelName());
			 Log.d("lueseypid", mChannelList.get(key).getChannelNumber() + "번");
		}
		*/
		
		//Log.d("lueseypid", "끝나쓰!");
	}
	
	
	private void parsingChannelInfo(XmlPullParser xpp) 
			throws XmlPullParserException, IOException, ParseException {
		
		int eventType=xpp.getEventType();
		
		while(eventType!=XmlPullParser.END_DOCUMENT) {
			switch(eventType) {
			
			case XmlPullParser.START_TAG:
				if(xpp.getName().equals("channel")) {
					String id=xpp.getAttributeValue(null, "id");
					
					xpp.nextTag();
					xpp.next();
					xpp.nextTag();
					xpp.nextTag();
					xpp.next();
					
					int channelNumber=Integer.parseInt(xpp.getText());
					
					xpp.nextTag();
					xpp.nextTag();
					xpp.next();
					String channelName=xpp.getText();
					
					mChannelList.put(id, new Channel(id, channelName, channelNumber));
				}
				
				else if(xpp.getName().equals("programme")) {
					parsingTvProgrameInfo(xpp, eventType);
				}
				break;
				
			case XmlPullParser.END_TAG:
				break;
			case XmlPullParser.TEXT:
				break;
			}
			
			eventType=xpp.next();
		}
	}
	
	private void parsingTvProgrameInfo(XmlPullParser xpp, int eventType) throws XmlPullParserException, IOException, ParseException {
		
		TvPrograme tvPrograme = new TvPrograme();
		
		while(true) {
			switch(eventType) {
			case XmlPullParser.START_TAG:
				
				if(xpp.getName().equals("programme")) {
					String id=xpp.getAttributeValue(null, "channel");
					String startTime=xpp.getAttributeValue(null, "start");
					String endTime=xpp.getAttributeValue(null, "stop");
					
					tvPrograme.setId(id);
					tvPrograme.setStartTime(startTime);
					tvPrograme.setEndTime(endTime);
				}

				else if(xpp.getName().equals("title")) {
					xpp.next();
					String title=xpp.getText();
					tvPrograme.setTitle(title);
				}
				
				else if(xpp.getName().equals("sub-title")) {
					xpp.next();
					String subTitle=xpp.getText();
					tvPrograme.setSubTitle(subTitle);
				}
				
				else if(xpp.getName().equals("value")) {
					xpp.next();
					String permission=xpp.getText();
					tvPrograme.setPermission(permission);
				}
				
				else if(xpp.getName().equals("director")) {
					xpp.next();
					tvPrograme.addDirector(xpp.getText());

				}
				
				else if(xpp.getName().equals("actor")) {
					xpp.next();
					tvPrograme.addDirector(xpp.getText());
				}
				
				else if(xpp.getName().equals("desc")) {
					xpp.next();
					String description=xpp.getText();
					tvPrograme.setDescription(description);
				}
				
				break;
				
			case XmlPullParser.END_TAG:
				if(xpp.getName().equals("programme")) { 
					Channel channel = mChannelList.get(tvPrograme.getId());
					channel.addTvPrograme(tvPrograme);
					return;
				}
				break;
			}
			
			eventType=xpp.next();
		}
	}
}
